<?xml version="1.0" encoding="UTF-8"?>
<project name="project" default="publish">
	<target name="deploy" depends="master.deploy,javadoc,ddf,ees">
	</target>

	<target name="init" depends="master.init">
        <taskdef resource="net/sf/antcontrib/antcontrib.properties" classpath="../licensed/ant/lib/ant-contrib-0.6.jar" />        
	</target>

	<macrodef name="javadoc.macro">
		<attribute name="name"/>
		<attribute name="packages"/>
		<attribute name="ddf.only" default="0"/>
		<sequential>
			<echo>@{name}</echo>
			<delete dir="${target}/@{name}"/>
			<mkdir dir="${target}/@{name}"/>
			<echo>
				Project output: ${project.output}
				Sourcepath    : ${project.allsourcepath}
				Destdir       : ${target}/@{name}
				Packages      : @{packages}
				Bootcp        : ${repo.javase}, ${repo.foundation}
				Classpath     : ${repo.servlet}, ${repo.jpa}, ${repo.jaxp}
			</echo>
			<javadoc
				access="protected"
				encoding="UTF-8"
				packagenames="@{packages}"
				sourcepath="${project.allsourcepath}"
				destdir="${target}/@{name}">
			    <bootclasspath>
	      			<pathelement location="${repo.javase}"/>
	      			<pathelement location="${repo.foundation}"/>
	    		</bootclasspath>
			    <classpath>
					<pathelement location="${repo.servlet}" />
					<pathelement location="${repo.jpa}" />
					<pathelement location="${repo.jaxp}" />
	    		</classpath>
	            <doclet name="org.osgi.tools.xmldoclet.XmlDoclet"
	                    path="${bin}">
				</doclet>
			</javadoc>
			<java classname="com.icl.saxon.StyleSheet" classpath="${saxon}" fork="true">
				<arg value="${target}/@{name}/javadoc.xml" />
				<arg value="docbook/xsl/javadoc2docbook.xsl" />
				<arg value="destdir=${target}/@{name}/docbook" />
				<arg value="ddf.only=@{ddf.only}" />
			</java>
		</sequential>
	</macrodef>

	<target name="javadoc" depends="compile">
		<javadoc.macro name="javadoc" packages="${javadoc.packages}" />
	</target>

	<target name="ddf" depends="compile">
		<javadoc.macro name="ddf" packages="org.osgi.dmt.*" ddf.only="1" />
	</target>
<!--
		Need to fix this up. But we don't need to make MIF anymore.
		<mkdir dir="mif" />
		<foreach delimiter=" ," target="-html2mif" param="item" inheritAll="true">
			<fileset dir="xml" includes="*.xml" />
		</foreach>
	<target name="-html2mif">
		<basename property="base" file="${item}" suffix=".xml" />
		<java classname="com.icl.saxon.StyleSheet" classpath="${saxon}" fork="true">
			<arg line="-o ${base}.tmp xml/${base}.xml xsl/html2mif.xsl" />
		</java>
		<java classname="org.osgi.tools.xml2mif.XML2MIF" fork="true" classpath="${xml2mif}">
			<arg line="-i ${base}.tmp -o mif/${base}.mif" />
		</java>
		<delete file="${base}.tmp" />
	</target>

-->

	<target name="ees" depends="init">
		<echo>${minimum-latest.jar}</echo>
		<echo>${foundation-latest.jar}</echo>
		<java classname="org.osgi.tools.jar2xml.JAR2XML" classpath="${jar2xml}" fork="true" output="ee.xml">
			<arg line="-tagged minimum ${minimum-latest.jar}" />
			<arg line="-tagged foundation ${foundation-latest.jar}" />
		</java>
		<echo>Converted JARs to XML</echo>
		<java classname="com.icl.saxon.StyleSheet" classpath="${saxon}" fork="true" output="ee.html">
			<arg line="ee.xml xsl/ee.xsl" />
		</java>
		<echo>Generated HTML file</echo>
		<java classname="com.icl.saxon.StyleSheet" classpath="${saxon}" fork="true" output="ee.tmp">
			<arg line="ee.html xsl/html2mif.xsl" />
		</java>
		<java classname="org.osgi.tools.xml2mif.XML2MIF" fork="true" classpath="${xml2mif}" input="ee.tmp" output="mif/ee.mif">
		</java>
	</target>

	<target name="eediff" depends="init">
		<taskdef resource="dependencyfindertasks.properties" classpath="${dependencyfinder}" />

		<antcall target="-eediff">
			<param name="ee" value="minimum"/>
			<param name="ee.previous.jar" value="${minimum-previous.jar}"/>
			<param name="ee.latest.jar" value="${minimum-latest.jar}"/>
			<param name="ee.previous" value="${minimum-previous}"/>
			<param name="ee.latest" value="${minimum-latest}"/>
		</antcall>

		<!--
		<antcall target="-eediff">
			<param name="ee" value="foundation"/>
			<param name="ee.latest.jar" value="${foundation-latest.jar}"/>
			<param name="ee.previous.jar" value="${foundation-previous.jar}"/>
			<param name="ee.latest" value="${foundation-latest}"/>
			<param name="ee.previous" value="${foundation-previous}"/>
		</antcall>
		-->
		</target>
		
	<target name="-eediff">
		<echo>Reading ${ee} ${ee.latest.jar} ${ee.previous.jar} ${ee.latest} ${ee.previous}</echo>
		<jarjardiff destfile="${target}/ee.diff.xml"
		              name="ee.${ee}"
		              oldlabel="${ee.previous}"
		              newlabel="${ee.latest}">
		    <old>
		      <pathelement location="${ee.previous.jar}"/>
		    </old>
		    <new>
			  <pathelement location="${ee.latest.jar}"/>
		    </new>
		  </jarjardiff>
		
		<java classname="com.icl.saxon.StyleSheet" classpath="${saxon}" fork="true" output="${target}/ee.diff.html">
			<arg line="${target}/ee.diff.xml xsl/eediff.xsl" />
		</java>
		
		<echo>Generated HTML file</echo>
		<java classname="com.icl.saxon.StyleSheet" classpath="${saxon}" fork="true" output="${target}/ee.diff.tmp">
			<arg line="${target}/ee.diff.html xsl/html2mif.xsl" />
		</java>
		<java classname="org.osgi.tools.xml2mif.XML2MIF" fork="true" classpath="${xml2mif}" input="${target}/ee.diff.tmp" output="mif/ee.${ee}.diff.mif"/>
	</target>

<!-- obsolete
	<target name="ddf" depends="init">
		<deltree dir="ddftmp" />
		<copy flatten="true" todir="ddftmp" failonerror="true" verbose="true">
			<fileset dir="../ddf" includes="**/*.xml" />
		</copy>
		<foreach list="${ddf}" delimiter=" ," target="-ddf2mif" param="item" inheritAll="true" />
	</target>

	<target name="coverage" depends="init">
		<echo>Coverage Core</echo>
		<java classname="com.icl.saxon.StyleSheet" classpath="${saxon}" fork="true" output="html.tmp">
			<arg line="../osgi.test/osgi.core.html xsl/html2mif.xsl" />
		</java>
		<java classname="org.osgi.tools.xml2mif.XML2MIF" fork="true" classpath="${xml2mif}" input="html.tmp" output="mif/org.osgi.core.mif">
		</java>
	</target>

	<target name="-ddf2mif">
		<java classname="com.icl.saxon.StyleSheet" classpath="${saxon}" fork="true" output="ddftmp/${item}.htm">
			<arg line="ddftmp/${item}.xml xsl/ddf2mif.xsl" />
		</java>
		<echo>Generated HTML file</echo>
		<java classname="com.icl.saxon.StyleSheet" classpath="${saxon}" fork="true" output="ddftmp/${item}.tmp">
			<arg line="ddftmp/${item}.htm xsl/html2mif.xsl" />
		</java>
		<echo>Generated XML MIF file</echo>
		<java classname="org.osgi.tools.xml2mif.XML2MIF" fork="true" classpath="${xml2mif}" input="ddftmp/${item}.tmp" output="mif/${item}.mif">
		</java>
		<echo>Generated MIF file</echo>
	</target>
-->
	<target name="echo" depends="master.echo">
		<echo>core.specs:             ${core.specs}</echo>
		<echo>cmpn.specs:             ${cmpn.specs}</echo>
		<echo>residential.specs:      ${residential.specs}</echo>
		<echo>enterprise.specs:       ${enterprise.specs}</echo>
		<echo>proposed.specs:         ${proposed.specs}</echo>
	</target>

	<import file="../cnf/master.xml" />
</project>
